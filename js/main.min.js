document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  let currentTab = 'all';
  let isUserAuthenticated = false;

  // Tab button event listeners
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      currentTab = button.dataset.tab;
      
      document.getElementById('imdbInput').value = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearchBtn').style.display = 'none';
      
      let searchPlaceholder = 'Search for movies or series...';
      let imdbPlaceholder = 'Enter IMDb ID directly (e.g., tt1234567)';
      
      if (currentTab === 'movies') {
        searchPlaceholder = 'Search for movies...';
        imdbPlaceholder = 'Enter Movie IMDb ID';
      } else if (currentTab === 'series') {
        searchPlaceholder = 'Search for series...';
        imdbPlaceholder = 'Enter Series IMDb ID';
      }
      
      document.getElementById('searchInput').placeholder = searchPlaceholder;
      document.getElementById('imdbInput').placeholder = imdbPlaceholder;
    });
  });

  // Player configuration
  const IndStreamPlayerConfigs = {
    width: 380,
    height: 280,
    id: 'IndStreamPlayer',
    tr: false
  };

  const VidSrcDomain = 'https://vidsrcme.ru/';
  const VinoStreamDomain = 'https://lethe399key.com';
  let initIndStreamPlayer = false;

  // Authentication listener
  function setupAuthListener() {
    if (window.authManager) {
      window.authManager.onAuthStateChange(user => {
        isUserAuthenticated = !!user;
        updatePlayerAccess();
      });
    } else {
      setTimeout(setupAuthListener, 100);
    }
  }

  function updatePlayerAccess() {
    const playerSection = document.querySelector('.player-section');
    const playButton = document.getElementById('playButton');
    
    if (!isUserAuthenticated) {
      showAuthRequiredMessage();
    } else {
      hideAuthRequiredMessage();
    }
  }

  function showAuthRequiredMessage() {
    let authMessage = document.getElementById('auth-required-message');
    if (!authMessage) {
      authMessage = document.createElement('div');
      authMessage.id = 'auth-required-message';
      authMessage.className = 'auth-required-message';
      authMessage.innerHTML = `
        <div class="auth-message-content">
          <i class="fas fa-lock"></i>
          <h3>Authentication Required</h3>
          <p>Please log in to access the movie player</p>
          <div class="auth-message-buttons">
            <button class="auth-message-btn login" onclick="document.getElementById('loginBtn').click()">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </button>
            <button class="auth-message-btn signup" onclick="document.getElementById('signupBtn').click()">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </button>
          </div>
        </div>
      `;
      const playerContainer = document.querySelector('.player-container');
      playerContainer.appendChild(authMessage);
    }
    authMessage.style.display = 'flex';
  }

  function hideAuthRequiredMessage() {
    const authMessage = document.getElementById('auth-required-message');
    if (authMessage) {
      authMessage.style.display = 'none';
    }
  }

  // Play button event listener
  document.getElementById('playButton').addEventListener('click', async function() {
    if (!isUserAuthenticated) {
      alert('Please log in to watch movies.');
      document.getElementById('loginBtn').click();
      return;
    }

    const imdbID = document.getElementById('imdbInput').value.trim();
    if (!imdbID) {
      alert('Please enter a valid IMDb ID.');
      return;
    }

    if (!window.selectedMovieData || window.selectedMovieData.imdbID !== imdbID) {
      console.log('üîç Movie data not available, fetching now...');
      await ensureMovieDataExists(imdbID, currentTab);
    } else {
      console.log('‚úÖ Movie data already available, tracking watch history...');
      await trackWatchHistoryNow(imdbID, currentTab);
    }

    let streamUrl;
    if (currentTab === 'all') {
      streamUrl = `${VinoStreamDomain}/play/${imdbID}`;
      VinoStreamAjax(
        streamUrl,
        () => { loadIframe(streamUrl); },
        () => { alert('Wait 10-15 Seconds After Clicking On Play'); }
      );
    } else if (currentTab === 'movies') {
      streamUrl = `${VidSrcDomain}/embed/movie/${imdbID}`;
      loadIframe(streamUrl);
    } else if (currentTab === 'series') {
      streamUrl = `${VidSrcDomain}/embed/tv/${imdbID}`;
      loadIframe(streamUrl);
    }
  });

  function loadIframe(url) {
    const playerContainer = document.getElementById(IndStreamPlayerConfigs.id);
    playerContainer.innerHTML = '';
    
    const iframe = document.createElement('iframe');
    iframe.setAttribute('src', url);
    iframe.setAttribute('width', IndStreamPlayerConfigs.width);
    iframe.setAttribute('height', IndStreamPlayerConfigs.height);
    iframe.setAttribute('frameborder', '0');
    iframe.setAttribute('allowfullscreen', 'true');
    playerContainer.appendChild(iframe);
    
    iframe.onload = async function() {
      console.log('Iframe loaded successfully.');
      const imdbID = document.getElementById('imdbInput').value.trim();
      
      if (imdbID && window.authManager && window.authManager.isAuthenticated()) {
        let type = 'movie';
        if (currentTab === 'all') type = 'all';
        if (currentTab === 'series') type = 'series';
        
        console.log('Adding to watch history:', imdbID, type);
        try {
          await trackWatchHistoryNow(imdbID, currentTab);
        } catch (error) {
          console.error('Error adding to watch history:', error);
        }
      } else {
        console.log('Not adding to history - missing requirements:', {
          imdbID: !!imdbID,
          authManager: !!window.authManager,
          authenticated: window.authManager ? window.authManager.isAuthenticated() : false
        });
      }
    };
    
    iframe.onerror = function() {
      playerContainer.innerHTML = '<p style="color:white;">Error loading the stream. Please try again.</p>';
    };
  }

  function VinoStreamAjax(url, success, error) {
    const xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState === XMLHttpRequest.DONE) {
        if (xhr.status === 200) {
          if (typeof success === 'function') success();
        } else {
          if (typeof error === 'function') error();
        }
      }
    };
    xhr.open('GET', url, true);
    xhr.send(null);
  }

  // Message listener for VinoStream
  if (window.addEventListener) {
    window.addEventListener('message', listener);
  } else {
    window.attachEvent('onmessage', listener);
  }

  function listener(event) {
    if (event.origin === VinoStreamDomain && !initIndStreamPlayer) {
      if (event.data && event.data.event) {
        const playerContainer = document.getElementById(IndStreamPlayerConfigs.id);
        if (event.data.event === 'init') {
          initIndStreamPlayer = true;
        } else if (event.data.event === 'error' && playerContainer) {
          playerContainer.innerHTML = '';
        }
      }
    }
  }

  async function ensureMovieDataExists(imdbID, currentTab) {
    console.log('üé¨ Ensuring movie data exists for:', imdbID);
    const playButton = document.getElementById('playButton');
    const originalText = playButton.innerHTML;
    playButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    playButton.disabled = true;
    
    try {
      if (!window.selectedMovieData || window.selectedMovieData.imdbID !== imdbID) {
        console.log('üîç Fetching movie details for direct IMDb entry...');
        const movieData = await fetchMovieDetailsDirectly(imdbID);
        
        if (movieData) {
          window.selectedMovieData = {
            title: movieData.title,
            poster: movieData.poster,
            year: movieData.year,
            type: movieData.type,
            imdbID: imdbID
          };
          console.log('üíæ Successfully stored movie data:', window.selectedMovieData);
          document.getElementById('searchInput').value = `${movieData.title} (${movieData.year})`;
        } else {
          console.log('‚ö†Ô∏è Could not fetch movie data, will use API fallback in watch history');
        }
      } else {
        console.log('‚úÖ Movie data already exists for this IMDb ID');
      }
      
      console.log('üìù Tracking in watch history...');
      await trackWatchHistoryNow(imdbID, currentTab);
    } catch (error) {
      console.error('‚ùå Error in ensureMovieDataExists:', error);
      await trackWatchHistoryNow(imdbID, currentTab);
    } finally {
      playButton.innerHTML = originalText;
      playButton.disabled = false;
    }
  }

  async function fetchMovieDetailsDirectly(imdbId) {
    console.log('üé¨ Fetching movie details for direct entry:', imdbId);
    const omdbKeys = ['thewdb', 'trilogy', '564727fa', '8265bd1c', 'b9a9e5c6', 'a1b2c3d4'];
    
    for (const apiKey of omdbKeys) {
      try {
        const url = `https://www.omdbapi.com/?i=${imdbId}&apikey=${apiKey}`;
        console.log('üåê Making API call to:', url);
        const response = await fetch(url);
        console.log('üì° Response status:', response.status, response.statusText);
        
        if (response.ok) {
          const data = await response.json();
          console.log('üì¶ Raw API response:', data);
          
          if (data.Response === 'True') {
            const movieData = {
              title: data.Title,
              poster: data.Poster !== 'N/A' ? data.Poster : null,
              year: data.Year,
              type: data.Type?.toLowerCase() === 'series' ? 'series' : 'movie',
              genre: data.Genre,
              plot: data.Plot
            };
            console.log('‚úÖ Successfully processed movie details:', movieData);
            return movieData;
          } else {
            console.log('‚ùå OMDb API returned error:', data.Error);
          }
        } else {
          console.log('‚ùå HTTP error:', response.status, response.statusText);
        }
      } catch (error) {
        console.warn(`‚ùå OMDb API key ${apiKey} failed:`, error);
        continue;
      }
    }
    
    console.log('‚ùå All OMDb API keys failed');
    throw new Error('Failed to fetch movie details from all OMDb API keys');
  }

  async function trackWatchHistoryNow(imdbID, tab) {
    console.log('üéØ trackWatchHistoryNow called with:', imdbID, tab);
    
    if (!window.authManager) {
      console.log('‚è≥ AuthManager not available yet, retrying in 1 second...');
      setTimeout(() => trackWatchHistoryNow(imdbID, tab), 1000);
      return;
    }
    
    if (!window.authManager.isAuthenticated()) {
      console.log('üîí User not authenticated, cannot track watch history');
      return;
    }
    
    let type = 'movie';
    if (tab === 'all') type = 'all';
    if (tab === 'series') type = 'series';
    
    let title = null;
    let poster = null;
    let year = null;
    
    console.log('üîç Checking for stored movie data...');
    console.log('üìä window.selectedMovieData:', window.selectedMovieData);
    
    if (window.selectedMovieData && window.selectedMovieData.imdbID === imdbID) {
      title = window.selectedMovieData.title;
      poster = window.selectedMovieData.poster;
      year = window.selectedMovieData.year;
      console.log('‚úÖ Using stored movie data:', { title, poster, year });
    } else {
      console.log('‚ùå No stored movie data found, will use API fallback');
    }
    
    console.log('üìù Adding to watch history with data:', { imdbID, type, title, poster, year });
    
    try {
      await window.authManager.addToWatchHistory(imdbID, type, title, poster, year);
      console.log('‚úÖ Successfully added to watch history');
    } catch (error) {
      console.error('‚ùå Error adding to watch history:', error);
    }
  }

  // Auto-fetch movie details when IMDb ID is entered
  let imdbFetchTimeout = null;
  document.getElementById('imdbInput').addEventListener('input', function() {
    const currentImdbId = this.value.trim();
    clearTimeout(imdbFetchTimeout);
    
    if (window.selectedMovieData && window.selectedMovieData.imdbID !== currentImdbId) {
      console.log('üîÑ IMDb input changed, clearing stored movie data');
      window.selectedMovieData = null;
      document.getElementById('searchInput').value = '';
    }
    
    if (currentImdbId && (currentImdbId.startsWith('tt') || currentImdbId.startsWith('tmdb'))) {
      console.log('üé¨ Valid IMDb ID detected, auto-fetching details...');
      imdbFetchTimeout = setTimeout(async () => {
        await autoFetchMovieDetails(currentImdbId);
      }, 500);
    }
  });

  async function autoFetchMovieDetails(imdbId) {
    console.log('üîç Auto-fetching movie details for:', imdbId);
    
    try {
      const movieData = await fetchMovieDetailsDirectly(imdbId);
      
      if (movieData) {
        window.selectedMovieData = {
          title: movieData.title,
          poster: movieData.poster,
          year: movieData.year,
          type: movieData.type,
          imdbID: imdbId
        };
        console.log('‚úÖ Auto-fetched and stored movie data:', window.selectedMovieData);
        document.getElementById('searchInput').value = `${movieData.title} (${movieData.year})`;
        
        const imdbInput = document.getElementById('imdbInput');
        const originalBorder = imdbInput.style.border;
        imdbInput.style.border = '2px solid #28a745';
        setTimeout(() => {
          imdbInput.style.border = originalBorder;
        }, 1000);
      } else {
        console.log('‚ùå Could not auto-fetch movie details');
        const imdbInput = document.getElementById('imdbInput');
        const originalBorder = imdbInput.style.border;
        imdbInput.style.border = '2px solid #dc3545';
        setTimeout(() => {
          imdbInput.style.border = originalBorder;
        }, 1000);
      }
    } catch (error) {
      console.error('‚ùå Error auto-fetching movie details:', error);
    }
  }

  setupAuthListener();
  initializeRecommendationSystem();
});

function initializeRecommendationSystem() {
  console.log('ü§ñ Initializing AI Recommendation System...');
  
  if (!window.aiRecommendationEngine) {
    setTimeout(initializeRecommendationSystem, 100);
    return;
  }

  function getSelectedGenres() {
    const activeGenreButtons = document.querySelectorAll('.genre-btn.active');
    return Array.from(activeGenreButtons).map(btn => btn.dataset.genre);
  }

  // Genre button listeners
  const genreButtons = document.querySelectorAll('.genre-btn');
  genreButtons.forEach(button => {
    button.addEventListener('click', () => {
      button.classList.toggle('active');
      updateRecommendationButtonText();
    });
  });

  // Clear genres button
  const clearGenresBtn = document.getElementById('clearGenresBtn');
  if (clearGenresBtn) {
    clearGenresBtn.addEventListener('click', () => {
      genreButtons.forEach(btn => btn.classList.remove('active'));
      updateRecommendationButtonText();
      
      const container = document.getElementById('recommendationsContainer');
      if (container) {
        container.innerHTML = `
          <div class="recommendations-placeholder">
            <i class="fas fa-robot"></i>
            <h3>Ready to discover amazing content?</h3>
            <p>Select your favorite genres above and click "Get AI Recommendations" to see personalized suggestions based on your preferences and viewing history.</p>
            <div class="ai-features">
              <div class="ai-feature">
                <i class="fas fa-brain"></i>
                <span>Smart Genre Analysis</span>
              </div>
              <div class="ai-feature">
                <i class="fas fa-history"></i>
                <span>Learning from Your History</span>
              </div>
              <div class="ai-feature">
                <i class="fas fa-star"></i>
                <span>Quality-Based Scoring</span>
              </div>
            </div>
          </div>
        `;
      }
    });
  }

  // Get recommendations button
  const getRecommendationsBtn = document.getElementById('getRecommendationsBtn');
  if (getRecommendationsBtn) {
    getRecommendationsBtn.addEventListener('click', async () => {
      const selectedGenres = getSelectedGenres();
      const contentType = document.getElementById('recommendationType').value;
      const language = document.getElementById('recommendationLanguage').value;
      
      console.log('üéØ Getting recommendations for:', { selectedGenres, contentType, language });
      
      try {
        getRecommendationsBtn.disabled = true;
        getRecommendationsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        
        const recommendations = await window.aiRecommendationEngine.getRecommendations(
          selectedGenres,
          contentType,
          12,
          language
        );
        
        window.aiRecommendationEngine.displayRecommendations(recommendations, selectedGenres);
        
        const recommendationsSection = document.querySelector('.recommendations-section');
        if (recommendationsSection) {
          recommendationsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      } catch (error) {
        console.error('‚ùå Error getting recommendations:', error);
        const container = document.getElementById('recommendationsContainer');
        if (container) {
          container.innerHTML = `
            <div class="no-recommendations">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error Getting Recommendations</h3>
              <p>Sorry, we encountered an error while generating recommendations. Please try again later.</p>
            </div>
          `;
        }
      } finally {
        getRecommendationsBtn.disabled = false;
        updateRecommendationButtonText();
      }
    });
  }

  function updateRecommendationButtonText() {
    const selectedGenres = getSelectedGenres();
    const btn = document.getElementById('getRecommendationsBtn');
    
    if (btn) {
      if (selectedGenres.length === 0) {
        btn.innerHTML = '<i class="fas fa-magic"></i> Get AI Recommendations';
      } else if (selectedGenres.length === 1) {
        btn.innerHTML = `<i class="fas fa-magic"></i> Get ${selectedGenres[0]} Recommendations`;
      } else {
        btn.innerHTML = `<i class="fas fa-magic"></i> Get Recommendations (${selectedGenres.length} genres)`;
      }
    }
  }

  console.log('‚úÖ AI Recommendation System initialized successfully');
}